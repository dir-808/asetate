{% extends "base.html" %}

{% block title %}Collection - Asetate{% endblock %}

{% block content %}
<div class="collection-layout">
    <div class="collection-page" id="collection-main">
        <header class="collection-header">
            <div class="collection-title">
                <h1>Your Collection</h1>
                <div class="collection-stats">
                    <span>{{ stats.releases }} releases</span>
                    <span class="stat-divider">‚Ä¢</span>
                    <span>{{ stats.tracks }} tracks</span>
                    <span class="stat-divider">‚Ä¢</span>
                    <span class="text-success">{{ stats.playable }} playable</span>
                </div>
            </div>
        </header>

        <div class="collection-toolbar">
            <form class="search-form" method="get" action="{{ url_for('releases.list_releases') }}">
                <input
                    type="search"
                    name="q"
                    placeholder="Search artist, title, label..."
                    value="{{ search }}"
                    class="search-input"
                >
                {% if filter_type %}
                <input type="hidden" name="filter" value="{{ filter_type }}">
                {% endif %}
                {% if crate_filter %}
                <input type="hidden" name="crate" value="{{ crate_filter }}">
                {% endif %}
            </form>

            <div class="filter-buttons">
                <a href="{{ url_for('releases.list_releases', q=search, crate=crate_filter) }}"
                   class="filter-btn {% if not filter_type %}active{% endif %}">
                    All
                </a>
                <a href="{{ url_for('releases.list_releases', q=search, filter='playable', crate=crate_filter) }}"
                   class="filter-btn {% if filter_type == 'playable' %}active{% endif %}">
                    Has Playable
                </a>
                <a href="{{ url_for('releases.list_releases', q=search, filter='needs_metadata', crate=crate_filter) }}"
                   class="filter-btn {% if filter_type == 'needs_metadata' %}active{% endif %}">
                    Needs BPM/Key
                </a>
                <div class="crate-filter-dropdown">
                    <select id="crate-filter-select" class="filter-select" onchange="filterByCrate(this.value)">
                        <option value="">All Crates</option>
                        {% for crate in available_crates %}
                        <option value="{{ crate.id }}" {% if crate_filter == crate.id|string %}selected{% endif %}>
                            {{ crate.icon or 'üìÅ' }} {{ crate.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        {% if releases %}
        <div class="releases-grid">
            {% for release in releases %}
            <div class="release-card" data-release-id="{{ release.id }}" data-crate-ids="{{ release.crate_ids|default([])|join(',') }}" tabindex="0">
                <div class="release-cover">
                    {% if release.cover_art_url %}
                    <img src="{{ release.cover_art_url }}" alt="{{ release.display_title }}" loading="lazy">
                    {% else %}
                    <div class="cover-placeholder">
                        <span>No Cover</span>
                    </div>
                    {% endif %}
                    {% if release.crate_icons %}
                    <div class="release-crate-icons">
                        {% for icon in release.crate_icons[:3] %}
                        <span class="release-crate-icon">{{ icon }}</span>
                        {% endfor %}
                        {% if release.crate_icons|length > 3 %}
                        <span class="release-crate-more">+{{ release.crate_icons|length - 3 }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="release-info">
                    <h3 class="release-title">{{ release.display_title }}</h3>
                    <p class="release-artist">{{ release.display_artist }}</p>
                    {% if release.label or release.year %}
                    <p class="release-meta">
                        {% if release.label %}{{ release.label }}{% endif %}
                        {% if release.label and release.year %} ‚Ä¢ {% endif %}
                        {% if release.year %}{{ release.year }}{% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        {% if pagination.pages > 1 %}
        <nav class="pagination">
            {% if pagination.has_prev %}
            <a href="{{ url_for('releases.list_releases', page=pagination.prev_num, q=search, filter=filter_type) }}"
               class="pagination-btn">
                Previous
            </a>
            {% endif %}

            <span class="pagination-info">
                Page {{ pagination.page }} of {{ pagination.pages }}
            </span>

            {% if pagination.has_next %}
            <a href="{{ url_for('releases.list_releases', page=pagination.next_num, q=search, filter=filter_type) }}"
               class="pagination-btn">
                Next
            </a>
            {% endif %}
        </nav>
        {% endif %}

        {% else %}
        <div class="empty-state">
            {% if search or filter_type %}
            <h2>No releases found</h2>
            <p>Try adjusting your search or filters</p>
            <a href="{{ url_for('releases.list_releases') }}" class="btn btn-secondary">Clear filters</a>
            {% else %}
            <h2>Your collection is empty</h2>
            <p>Pull your vinyl collection from Discogs to get started</p>
            <a href="{{ url_for('sync.sync_page') }}" class="btn btn-primary">Pull from Discogs</a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Side Panel for Release Details -->
    <aside class="release-panel" id="release-panel">
        <div class="panel-header-bar">
            <span id="panel-expand-slot"></span>
            <button class="panel-close" id="panel-close" title="Close panel">&times;</button>
        </div>
        <div class="panel-content" id="panel-content">
            <div class="panel-loading">
                <span>Loading...</span>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Sidebar pushes content */
.collection-layout {
    display: flex;
    position: relative;
    min-height: calc(100vh - 150px);
}

.collection-page {
    flex: 1;
    min-width: 0;
    transition: margin-right 0.3s ease-out;
}

.collection-page.panel-open {
    margin-right: 450px;
}

/* Panel slides in from right */
.release-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 450px;
    height: 100vh;
    background-color: var(--bg-surface);
    border-left: 2px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.3s ease-out;
    z-index: 900;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
}

.release-panel.open {
    transform: translateX(0);
}

.panel-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-elevated);
    border-bottom: 2px solid var(--border);
    flex-shrink: 0;
}

#panel-expand-slot {
    display: flex;
}

.panel-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
}


/* Crate icons on release cards */
.release-crate-icons {
    position: absolute;
    bottom: 4px;
    right: 4px;
    display: flex;
    gap: 2px;
}

.release-crate-icon {
    width: 20px;
    height: 20px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
}

.release-crate-more {
    width: 20px;
    height: 20px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.55rem;
    color: var(--text-muted);
}

.release-cover {
    position: relative;
}

/* Crate filter dropdown */
.crate-filter-dropdown {
    display: inline-block;
}

.filter-select {
    padding: var(--space-xs) var(--space-sm);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: 2px solid var(--border);
    background: transparent;
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
}

.filter-select option {
    background: var(--bg-surface);
    color: var(--text-primary);
}

/* Crate badge in panel (without color) */
.crate-badge-panel {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    font-size: 0.75rem;
    background-color: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    text-decoration: none;
    transition: background-color 0.15s, border-color 0.15s;
}

.crate-badge-panel:hover {
    background-color: var(--bg-hover);
    border-color: var(--text-muted);
}
</style>
<script>
// Crate filter function
function filterByCrate(crateId) {
    const url = new URL(window.location);
    if (crateId) {
        url.searchParams.set('crate', crateId);
    } else {
        url.searchParams.delete('crate');
    }
    window.location.href = url.toString();
}

(function() {
    const panel = document.getElementById('release-panel');
    const panelContent = document.getElementById('panel-content');
    const panelClose = document.getElementById('panel-close');
    const collectionMain = document.getElementById('collection-main');
    let currentReleaseId = null;

    // Open panel with release details
    async function openPanel(releaseId) {
        if (currentReleaseId === releaseId && panel.classList.contains('open')) {
            return; // Already showing this release
        }

        currentReleaseId = releaseId;
        panel.classList.add('open');
        collectionMain.classList.add('panel-open');
        panelContent.innerHTML = '<div class="panel-loading"><span>Loading...</span></div>';

        // Update URL without full navigation
        const url = new URL(window.location);
        url.searchParams.set('r', releaseId);
        history.pushState({ releaseId }, '', url);

        // Highlight selected card
        document.querySelectorAll('.release-card').forEach(card => {
            card.classList.toggle('selected', card.dataset.releaseId == releaseId);
        });

        try {
            const response = await fetch(`/releases/${releaseId}/panel`);
            if (response.ok) {
                const html = await response.text();
                panelContent.innerHTML = html;

                // Move expand button to header bar
                // Use querySelector on panelContent to get the NEW button, not the old one in the slot
                const expandSlot = document.getElementById('panel-expand-slot');
                if (expandSlot) {
                    expandSlot.innerHTML = ''; // Clear any old button first
                }
                const expandBtn = panelContent.querySelector('#panel-expand-btn');
                if (expandBtn && expandSlot) {
                    expandBtn.style.display = 'flex';
                    expandSlot.appendChild(expandBtn);
                }

                // Execute scripts that were loaded with the panel
                panelContent.querySelectorAll('script').forEach(oldScript => {
                    const newScript = document.createElement('script');
                    newScript.textContent = oldScript.textContent;
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
            } else {
                panelContent.innerHTML = '<div class="panel-error">Failed to load release</div>';
            }
        } catch (err) {
            panelContent.innerHTML = '<div class="panel-error">Network error</div>';
        }
    }

    // Close panel
    function closePanel() {
        panel.classList.remove('open');
        collectionMain.classList.remove('panel-open');
        currentReleaseId = null;

        // Remove release param from URL
        const url = new URL(window.location);
        url.searchParams.delete('r');
        history.pushState({}, '', url);

        // Remove selected state
        document.querySelectorAll('.release-card').forEach(card => {
            card.classList.remove('selected');
        });
    }

    // Handle release card clicks
    document.querySelectorAll('.release-card').forEach(card => {
        card.addEventListener('click', (e) => {
            e.preventDefault();
            openPanel(card.dataset.releaseId);
        });

        // Keyboard support
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openPanel(card.dataset.releaseId);
            }
        });
    });

    // Close panel button
    panelClose.addEventListener('click', closePanel);

    // Close on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && panel.classList.contains('open')) {
            closePanel();
        }
    });

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
        const url = new URL(window.location);
        const releaseId = url.searchParams.get('r');
        if (releaseId) {
            openPanel(releaseId);
        } else {
            closePanel();
        }
    });

    // Check if URL has release param on load
    const url = new URL(window.location);
    const releaseId = url.searchParams.get('r');
    if (releaseId) {
        openPanel(releaseId);
    }
})();
</script>
{% endblock %}
