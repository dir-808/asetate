{# Side panel partial for release details - loaded via AJAX #}
<div class="panel-release" data-release-id="{{ release.id }}">
    <!-- Full page button in top left -->
    <a href="{{ url_for('releases.view_release', release_id=release.id) }}" class="panel-fullpage-corner" title="Open full page">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
        </svg>
    </a>

    <header class="panel-header">
        <div class="panel-cover">
            {% if release.cover_art_url %}
            <img src="{{ release.cover_art_url }}" alt="{{ release.display_title }}">
            {% else %}
            <div class="cover-placeholder-panel">
                <span>No Cover</span>
            </div>
            {% endif %}
        </div>
        <div class="panel-info">
            <h2>{{ release.display_title }}</h2>
            <p class="panel-artist">{{ release.display_artist }}</p>
            <div class="panel-meta">
                {% if release.label %}<span>{{ release.label }}</span>{% endif %}
                {% if release.year %}<span>{{ release.year }}</span>{% endif %}
            </div>
            {% set avg_bpm = release.get_average_bpm() %}
            <div class="panel-stats">
                <span>{{ stats.total }} tracks</span>
                <span class="stat-divider">‚Ä¢</span>
                <span class="text-success">{{ stats.playable }} playable</span>
                {% if avg_bpm.value %}
                <span class="stat-divider">‚Ä¢</span>
                <span class="avg-bpm {% if avg_bpm.is_varied %}bpm-varied{% endif %}">{{ avg_bpm.display }}</span>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="panel-actions">
        <a href="{{ release.discogs_uri }}" target="_blank" rel="noopener" class="btn btn-secondary btn-sm">Discogs</a>
        <button class="btn btn-primary btn-sm" id="panel-btn-add-to-crate">Crate</button>
        <button class="btn btn-secondary btn-sm" id="panel-btn-add-to-cue" title="Add to export cue">Cue</button>
    </div>

    <div class="panel-crates" id="panel-release-crates">
        <!-- Crates will be loaded via JS -->
    </div>

    <!-- Release Notes -->
    {% if release.notes %}
    <div class="panel-notes">
        <h4>Notes</h4>
        <p>{{ release.notes }}</p>
    </div>
    {% endif %}

    <!-- Tracks Section -->
    <section class="panel-tracks">
        <div class="panel-tracks-header">
            <h3>Tracklist</h3>
            <span class="save-indicator" id="panel-save-indicator"></span>
        </div>

        {% if tracks %}
        <div class="panel-tracks-list" id="panel-tracks-list">
            {% for track in tracks %}
            <div class="panel-track-row {% if not track.is_playable %}track-dimmed{% endif %}"
                 data-track-id="{{ track.id }}">
                <div class="panel-track-main">
                    <span class="panel-track-pos">{{ track.display_position }}</span>
                    <div class="panel-track-info">
                        <span class="panel-track-title">{{ track.title }}</span>
                        <span class="panel-track-duration">{{ track.display_duration }}</span>
                    </div>
                    <div class="panel-playable-toggle">
                        <label class="toggle toggle-sm" title="Playable">
                            <input type="checkbox" class="panel-track-playable"
                                   {% if track.is_playable %}checked{% endif %}
                                   data-field="is_playable">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="panel-track-fields">
                    <div class="panel-field panel-field-bpm">
                        <label>BPM</label>
                        <input type="number" class="panel-input panel-bpm"
                               value="{{ track.bpm or '' }}" placeholder="‚Äî"
                               min="20" max="300" data-field="bpm">
                    </div>
                    <div class="panel-field panel-field-key">
                        <label>Key</label>
                        <input type="text" class="panel-input panel-key"
                               value="{{ track.camelot or track.musical_key or '' }}"
                               placeholder="‚Äî" data-field="camelot" list="panel-camelot-keys">
                    </div>
                    <div class="panel-field panel-field-energy">
                        <label>NRG</label>
                        <div class="energy-bar-panel" data-field="energy" data-value="{{ track.energy or 3 }}">
                            <div class="energy-segment" data-level="1"></div>
                            <div class="energy-segment" data-level="2"></div>
                            <div class="energy-segment" data-level="3"></div>
                            <div class="energy-segment" data-level="4"></div>
                            <div class="energy-segment" data-level="5"></div>
                        </div>
                    </div>
                </div>
                <div class="panel-track-extras">
                    <button class="panel-notes-btn {% if track.notes %}has-notes{% endif %}"
                            data-track-id="{{ track.id }}"
                            data-track-notes="{{ track.notes or '' }}"
                            title="{% if track.notes %}Edit notes{% else %}Add notes{% endif %}">
                        {% if track.notes %}üìù{% else %}+Note{% endif %}
                    </button>
                    <div class="panel-track-tags" data-track-id="{{ track.id }}">
                        {% for tag in track.tags %}
                        <span class="tag-badge-sm" data-tag-id="{{ tag.id }}" style="--tag-color: {{ tag.color or '#E07A5F' }}">{{ tag.name }}</span>
                        {% endfor %}
                        <button class="panel-tag-add-btn" title="Add tag">+</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <datalist id="panel-camelot-keys">
            <option value="1A"><option value="1B">
            <option value="2A"><option value="2B">
            <option value="3A"><option value="3B">
            <option value="4A"><option value="4B">
            <option value="5A"><option value="5B">
            <option value="6A"><option value="6B">
            <option value="7A"><option value="7B">
            <option value="8A"><option value="8B">
            <option value="9A"><option value="9B">
            <option value="10A"><option value="10B">
            <option value="11A"><option value="11B">
            <option value="12A"><option value="12B">
        </datalist>
        {% else %}
        <p class="text-muted" style="padding: var(--space-md);">No tracks found.</p>
        {% endif %}
    </section>
</div>

<!-- Track Notes Modal (inline for panel) -->
<div class="panel-notes-modal" id="panel-track-notes-modal" style="display: none;">
    <div class="panel-notes-modal-content">
        <div class="panel-notes-modal-header">
            <h4>Track Notes</h4>
            <button class="modal-close" id="panel-notes-modal-close">&times;</button>
        </div>
        <textarea id="panel-track-notes-textarea" rows="4" placeholder="Add notes about this track..."></textarea>
        <div class="panel-notes-modal-actions">
            <button class="btn btn-secondary btn-sm" id="panel-notes-cancel">Cancel</button>
            <button class="btn btn-primary btn-sm" id="panel-notes-save">Save</button>
        </div>
    </div>
</div>

<!-- Tag datalist for autocomplete -->
<datalist id="panel-all-tags"></datalist>

<style>
/* Full page button - top left corner */
.panel-fullpage-corner {
    position: absolute;
    top: var(--space-sm);
    left: var(--space-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    z-index: 10;
    transition: all 0.15s;
}

.panel-fullpage-corner:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--primary-dim);
}

.panel-release {
    position: relative;
    padding-top: var(--space-xl);
}

/* Track row - dimmed for non-playable, orange box for playable */
.panel-track-row {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border);
    transition: opacity 0.15s, background-color 0.15s, box-shadow 0.15s;
}

.panel-track-row:last-child {
    border-bottom: none;
}

/* Non-playable tracks are dimmed */
.panel-track-row.track-dimmed {
    opacity: 0.5;
}

.panel-track-row.track-dimmed:hover {
    opacity: 0.7;
}

/* Playable tracks get a faint orange box */
.panel-track-row:not(.track-dimmed) {
    box-shadow: inset 0 0 0 1px rgba(249, 115, 22, 0.3);
    background-color: rgba(249, 115, 22, 0.03);
}

.panel-track-row:not(.track-dimmed):hover {
    background-color: rgba(249, 115, 22, 0.08);
}

/* Track main row */
.panel-track-main {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.panel-track-pos {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary);
    min-width: 28px;
}

.panel-track-info {
    flex: 1;
    min-width: 0;
}

.panel-track-title {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.panel-track-duration {
    font-size: 0.7rem;
    color: var(--text-secondary);
}

.panel-playable-toggle {
    flex-shrink: 0;
}

/* Track fields row */
.panel-track-fields {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-xs);
    padding-left: 28px;
    align-items: center;
}

.panel-field {
    display: flex;
    align-items: center;
    gap: 4px;
}

.panel-field label {
    font-size: 0.55rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.panel-field-bpm .panel-input,
.panel-field-key .panel-input {
    width: 45px;
}

.panel-input {
    padding: 2px 4px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    text-align: center;
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-primary);
}

.panel-input:hover {
    background: var(--bg-input);
    border-color: var(--border);
}

.panel-input:focus {
    background: var(--bg-input);
    border-color: var(--primary);
    outline: none;
}

/* Energy bar for panel - matches release page style */
.energy-bar-panel {
    display: flex;
    gap: 2px;
    height: 14px;
    cursor: pointer;
}

.energy-bar-panel .energy-segment {
    width: 10px;
    background-color: var(--border);
    border-radius: 2px;
    transition: background-color 0.15s, transform 0.1s;
}

.energy-bar-panel .energy-segment:hover {
    transform: scaleY(1.15);
}

.energy-bar-panel[data-value="1"] .energy-segment[data-level="1"] { background-color: var(--success); }
.energy-bar-panel[data-value="2"] .energy-segment[data-level="1"],
.energy-bar-panel[data-value="2"] .energy-segment[data-level="2"] { background-color: #84cc16; }
.energy-bar-panel[data-value="3"] .energy-segment[data-level="1"],
.energy-bar-panel[data-value="3"] .energy-segment[data-level="2"],
.energy-bar-panel[data-value="3"] .energy-segment[data-level="3"] { background-color: var(--warning); }
.energy-bar-panel[data-value="4"] .energy-segment[data-level="1"],
.energy-bar-panel[data-value="4"] .energy-segment[data-level="2"],
.energy-bar-panel[data-value="4"] .energy-segment[data-level="3"],
.energy-bar-panel[data-value="4"] .energy-segment[data-level="4"] { background-color: var(--primary); }
.energy-bar-panel[data-value="5"] .energy-segment { background-color: var(--error); }

/* Track extras row - notes and tags */
.panel-track-extras {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-xs);
    padding-left: 28px;
    flex-wrap: wrap;
}

.panel-notes-btn {
    font-size: 0.6rem;
    padding: 2px 6px;
    background: transparent;
    border: 1px dashed var(--border);
    color: var(--text-muted);
    cursor: pointer;
    font-family: var(--font-mono);
    transition: all 0.15s;
}

.panel-notes-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.panel-notes-btn.has-notes {
    border-style: solid;
    border-color: var(--warning);
    color: var(--warning);
    background-color: rgba(251, 191, 36, 0.1);
}

/* Panel tags */
.panel-track-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
}

.tag-badge-sm {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    padding: 1px 6px;
    font-size: 0.55rem;
    font-weight: 600;
    background-color: var(--tag-color, var(--primary));
    color: var(--bg-primary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    cursor: default;
}

.tag-badge-sm .tag-remove-sm {
    display: none;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 0;
    margin-left: 2px;
    font-size: 0.7rem;
    line-height: 1;
    opacity: 0.7;
}

.tag-badge-sm:hover .tag-remove-sm {
    display: inline;
}

.panel-tag-add-btn {
    width: 16px;
    height: 16px;
    padding: 0;
    border: 1px dashed var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.7rem;
    font-family: var(--font-mono);
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-tag-add-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.panel-tag-input {
    width: 60px;
    padding: 1px 4px;
    font-size: 0.6rem;
    background-color: var(--bg-input);
    border: 1px solid var(--primary);
    color: var(--text-primary);
}

/* Tracks list - no max-height, let it flow */
.panel-tracks-list {
    /* No max-height - removes unnecessary scrollbar */
}

/* Notes modal within panel */
.panel-notes-modal {
    position: fixed;
    top: 0;
    right: 0;
    width: 450px;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-notes-modal-content {
    background-color: var(--bg-surface);
    border: 2px solid var(--border);
    padding: var(--space-md);
    width: 90%;
    max-width: 350px;
}

.panel-notes-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.panel-notes-modal-header h4 {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

#panel-track-notes-textarea {
    width: 100%;
    padding: var(--space-sm);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-input);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.85rem;
    resize: vertical;
}

.panel-notes-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-sm);
    margin-top: var(--space-md);
}
</style>

<script>
(function() {
    const releaseId = {{ release.id }};
    const saveIndicator = document.getElementById('panel-save-indicator');
    let saveTimeout = null;
    let allTags = [];

    function showSaving() {
        saveIndicator.textContent = 'Saving...';
        saveIndicator.className = 'save-indicator saving';
    }

    function showSaved() {
        saveIndicator.textContent = 'Saved';
        saveIndicator.className = 'save-indicator saved';
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveIndicator.textContent = '';
            saveIndicator.className = 'save-indicator';
        }, 2000);
    }

    function showError() {
        saveIndicator.textContent = 'Error';
        saveIndicator.className = 'save-indicator error';
    }

    async function updateTrack(trackId, field, value) {
        showSaving();
        const data = {};
        data[field] = value;

        try {
            const response = await fetch(`/releases/${releaseId}/tracks/${trackId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showSaved();
                if (field === 'is_playable') {
                    const row = document.querySelector(`.panel-track-row[data-track-id="${trackId}"]`);
                    row.classList.toggle('track-dimmed', !value);
                    updatePanelStats();
                }
                if (field === 'bpm') {
                    updatePanelStats();
                }
            } else {
                showError();
            }
        } catch (err) {
            showError();
        }
    }

    // Update stats after changes
    function updatePanelStats() {
        const rows = document.querySelectorAll('.panel-track-row');
        let playableCount = 0;
        let totalBpm = 0;
        let bpmCount = 0;

        rows.forEach(row => {
            const isPlayable = !row.classList.contains('track-dimmed');
            if (isPlayable) {
                playableCount++;
                const bpmInput = row.querySelector('.panel-bpm');
                if (bpmInput && bpmInput.value) {
                    totalBpm += parseInt(bpmInput.value);
                    bpmCount++;
                }
            }
        });

        // Update playable count
        const statsEl = document.querySelector('.panel-stats .text-success');
        if (statsEl) {
            statsEl.textContent = `${playableCount} playable`;
        }

        // Update avg BPM
        const avgBpmEl = document.querySelector('.panel-stats .avg-bpm');
        if (avgBpmEl && bpmCount > 0) {
            avgBpmEl.textContent = Math.round(totalBpm / bpmCount);
        }
    }

    // Debounced input handler
    let debounceTimers = {};

    document.querySelectorAll('.panel-input').forEach(input => {
        input.addEventListener('input', (e) => {
            const row = input.closest('.panel-track-row');
            const trackId = row.dataset.trackId;
            const field = input.dataset.field;

            clearTimeout(debounceTimers[trackId + field]);
            debounceTimers[trackId + field] = setTimeout(() => {
                let value = input.value;
                if (value === '') value = null;
                updateTrack(trackId, field, value);
            }, 500);
        });
    });

    // Checkbox handler - immediate visual update
    document.querySelectorAll('.panel-track-playable').forEach(cb => {
        cb.addEventListener('change', (e) => {
            const row = cb.closest('.panel-track-row');
            const trackId = row.dataset.trackId;
            const isPlayable = cb.checked;

            // Immediate visual update before API call
            row.classList.toggle('track-dimmed', !isPlayable);

            updateTrack(trackId, 'is_playable', isPlayable);
        });
    });

    // Energy bar click handler
    document.querySelectorAll('.energy-bar-panel').forEach(bar => {
        bar.querySelectorAll('.energy-segment').forEach(segment => {
            segment.addEventListener('click', (e) => {
                const level = parseInt(segment.dataset.level);
                const row = bar.closest('.panel-track-row');
                const trackId = row.dataset.trackId;

                bar.setAttribute('data-value', level);
                updateTrack(trackId, 'energy', level);
            });
        });
    });

    // Track Notes Modal
    const notesModal = document.getElementById('panel-track-notes-modal');
    const notesTextarea = document.getElementById('panel-track-notes-textarea');
    let currentNotesTrackId = null;

    document.querySelectorAll('.panel-notes-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentNotesTrackId = btn.dataset.trackId;
            notesTextarea.value = btn.dataset.trackNotes || '';
            notesModal.style.display = 'flex';
            notesTextarea.focus();
        });
    });

    document.getElementById('panel-notes-modal-close')?.addEventListener('click', () => {
        notesModal.style.display = 'none';
    });

    document.getElementById('panel-notes-cancel')?.addEventListener('click', () => {
        notesModal.style.display = 'none';
    });

    document.getElementById('panel-notes-save')?.addEventListener('click', async () => {
        if (!currentNotesTrackId) return;

        const notes = notesTextarea.value.trim();
        showSaving();

        try {
            const response = await fetch(`/releases/${releaseId}/tracks/${currentNotesTrackId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes || null })
            });

            if (response.ok) {
                showSaved();
                notesModal.style.display = 'none';
                // Update button
                const btn = document.querySelector(`.panel-notes-btn[data-track-id="${currentNotesTrackId}"]`);
                if (btn) {
                    btn.dataset.trackNotes = notes;
                    if (notes) {
                        btn.textContent = 'üìù';
                        btn.classList.add('has-notes');
                    } else {
                        btn.textContent = '+Note';
                        btn.classList.remove('has-notes');
                    }
                }
            } else {
                showError();
            }
        } catch (err) {
            showError();
        }
    });

    // Load all tags for autocomplete
    async function loadAllTags() {
        try {
            const response = await fetch('/tags/');
            const data = await response.json();
            allTags = data.tags;
            // Populate datalist
            const datalist = document.getElementById('panel-all-tags');
            datalist.innerHTML = allTags.map(t => `<option value="${t.name}">`).join('');
        } catch (err) {
            console.error('Failed to load tags:', err);
        }
    }
    loadAllTags();

    // Tag management
    async function addTagToTrack(trackId, tagName) {
        try {
            const response = await fetch(`/tags/track/${trackId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: tagName.trim().toLowerCase() })
            });
            const result = await response.json();
            if (response.ok) {
                // Add new tag to allTags immediately if it doesn't exist
                if (!allTags.some(t => t.id === result.tag.id)) {
                    allTags.push(result.tag);
                    // Update datalist
                    const datalist = document.getElementById('panel-all-tags');
                    datalist.innerHTML = allTags.map(t => `<option value="${t.name}">`).join('');
                }
                return result.tag;
            }
            return null;
        } catch (err) {
            console.error('Failed to add tag:', err);
            return null;
        }
    }

    async function removeTagFromTrack(trackId, tagId) {
        try {
            await fetch(`/tags/track/${trackId}/${tagId}`, { method: 'DELETE' });
        } catch (err) {
            console.error('Failed to remove tag:', err);
        }
    }

    // Tag add button handler
    document.querySelectorAll('.panel-tag-add-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const container = btn.closest('.panel-track-tags');
            const trackId = container.dataset.trackId;

            // Check if input already exists
            if (container.querySelector('.panel-tag-input')) return;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'panel-tag-input';
            input.placeholder = 'tag';
            input.setAttribute('list', 'panel-all-tags');
            container.insertBefore(input, btn);
            input.focus();

            async function submitTag() {
                const value = input.value.trim();
                if (value) {
                    const tag = await addTagToTrack(trackId, value);
                    if (tag) {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'tag-badge-sm';
                        tagEl.dataset.tagId = tag.id;
                        tagEl.style.setProperty('--tag-color', tag.color || '#E07A5F');
                        tagEl.textContent = tag.name;
                        container.insertBefore(tagEl, input);
                    }
                }
                input.remove();
            }

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitTag();
                } else if (e.key === 'Escape') {
                    input.remove();
                }
            });

            // Apply tag on selecting from dropdown
            input.addEventListener('change', () => {
                if (input.value.trim()) {
                    submitTag();
                }
            });

            input.addEventListener('blur', () => {
                setTimeout(() => input.remove(), 150);
            });
        });
    });

    // Load crates for this release
    async function loadCrates() {
        try {
            const [cratesRes, releaseRes] = await Promise.all([
                fetch('/crates/api/list'),
                fetch(`/crates/api/for-release/${releaseId}`)
            ]);
            const cratesData = await cratesRes.json();
            const releaseData = await releaseRes.json();

            const allCrates = cratesData.crates;
            const releaseCrateIds = releaseData.crate_ids;
            const inCrates = allCrates.filter(c => releaseCrateIds.includes(c.id));

            const container = document.getElementById('panel-release-crates');
            if (inCrates.length > 0) {
                container.innerHTML = inCrates.map(c => {
                    return `<a href="/crates/${c.id}" class="crate-badge-panel">
                        <span class="crate-badge-icon">${c.icon || 'üìÅ'}</span>
                        <span class="crate-badge-name">${c.name}</span>
                    </a>`;
                }).join('');
            } else {
                container.innerHTML = '<span class="text-muted" style="font-size: 0.75rem;">Not in any crate</span>';
            }
        } catch (err) {
            console.error('Failed to load crates:', err);
        }
    }
    loadCrates();

    // Add to Cue
    const addCueBtn = document.getElementById('panel-btn-add-to-cue');
    if (addCueBtn) {
        addCueBtn.addEventListener('click', () => {
            const trackRows = document.querySelectorAll('.panel-track-row');
            const tracks = [];
            trackRows.forEach(row => {
                const trackId = parseInt(row.dataset.trackId);
                const title = row.querySelector('.panel-track-title')?.textContent || '';
                const position = row.querySelector('.panel-track-pos')?.textContent || '';
                tracks.push({
                    track_id: trackId,
                    release_id: releaseId,
                    artist: '{{ release.display_artist | e }}',
                    title: `${position} ${title}`.trim(),
                });
            });

            let exportCue = JSON.parse(localStorage.getItem('asetate_export_cue') || '[]');
            let addedCount = 0;
            tracks.forEach(track => {
                if (!exportCue.some(q => q.track_id === track.track_id)) {
                    exportCue.push(track);
                    addedCount++;
                }
            });
            localStorage.setItem('asetate_export_cue', JSON.stringify(exportCue));

            if (addedCount > 0) {
                addCueBtn.textContent = `+${addedCount}`;
                setTimeout(() => { addCueBtn.textContent = 'Cue'; }, 1500);
            } else {
                addCueBtn.textContent = 'In cue';
                setTimeout(() => { addCueBtn.textContent = 'Cue'; }, 1500);
            }
        });
    }
})();
</script>
