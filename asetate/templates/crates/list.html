{% extends "base.html" %}

{% block title %}Crates - Asetate{% endblock %}

{% block content %}
<div class="crates-page-layout">
    <div class="crates-main" id="crates-main">
        <header class="crates-header">
            <div>
                <h1>Crates</h1>
                <p class="text-secondary">{{ total_crates }} crate{% if total_crates != 1 %}s{% endif %}</p>
            </div>
            <button class="btn btn-primary" id="btn-new-crate">New Crate</button>
        </header>

        {% if crate_tree %}
        <div class="crates-grid">
            {% macro render_crate(node, depth=0) %}
            <a href="{{ url_for('crates.view_crate', crate_id=node.crate.id) }}"
               class="crate-box {% if depth > 0 %}sub-crate{% endif %}"
               data-crate-id="{{ node.crate.id }}"
               style="{% if node.crate.color_hex %}--crate-accent: {{ node.crate.color_hex }}{% endif %}">
                <!-- Crate lid (opens on hover) -->
                <div class="crate-lid">
                    <div class="crate-lid-inner">
                        <span class="crate-lid-label">{{ node.crate.name[:12] }}{% if node.crate.name|length > 12 %}...{% endif %}</span>
                    </div>
                </div>
                <!-- Crate body -->
                <div class="crate-body">
                    <div class="crate-icon-container">
                        <span class="crate-emoji">{{ node.crate.display_icon }}</span>
                    </div>
                    <div class="crate-info">
                        <span class="crate-name">{{ node.crate.name }}</span>
                        <span class="crate-stats">{{ node.release_count }} releases</span>
                    </div>
                    <!-- Action buttons (on hover) -->
                    <div class="crate-hover-actions">
                        <button class="crate-action-btn crate-edit-btn"
                                data-crate-id="{{ node.crate.id }}"
                                title="Edit">‚úé</button>
                        <button class="crate-action-btn crate-subcrate-btn"
                                data-crate-id="{{ node.crate.id }}"
                                data-crate-name="{{ node.crate.name }}"
                                title="Add sub-crate">+</button>
                    </div>
                </div>
                <!-- Crate slats (visual only) -->
                <div class="crate-slat crate-slat-1"></div>
                <div class="crate-slat crate-slat-2"></div>
            </a>
            {% if node.children %}
            {% for child in node.children %}
            {{ render_crate(child, depth + 1) }}
            {% endfor %}
            {% endif %}
            {% endmacro %}

            {% for node in crate_tree %}
            {{ render_crate(node) }}
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h2>No crates yet</h2>
            <p>Create crates to organize your releases and tracks by genre, mood, or however you like.</p>
            <button class="btn btn-primary" id="btn-new-crate-empty">Create Your First Crate</button>
        </div>
        {% endif %}
    </div>

    <!-- Crate Edit Sidebar -->
    <aside class="crate-panel" id="crate-panel">
        <div class="crate-panel-header">
            <h3>Edit Crate</h3>
            <button class="panel-close" id="crate-panel-close">&times;</button>
        </div>
        <div class="crate-panel-content" id="crate-panel-content">
            <!-- Content loaded via JS -->
        </div>
    </aside>
</div>

<!-- New Crate Modal -->
<div class="modal" id="new-crate-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">New Crate</h2>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <form id="new-crate-form">
            <div class="form-group">
                <label for="crate-name">Name</label>
                <input type="text" id="crate-name" name="name" placeholder="e.g., Deep House" required autofocus>
            </div>
            <div class="form-group">
                <label for="crate-description">Description (optional)</label>
                <input type="text" id="crate-description" name="description" placeholder="e.g., Late night vibes">
            </div>

            <!-- Icon Picker -->
            <div class="form-group">
                <label>Icon</label>
                <div class="icon-picker-container">
                    <div class="icon-input-row">
                        <button type="button" class="icon-preview" id="icon-preview" title="Click to select an emoji">üìÅ</button>
                        <input type="text"
                               id="crate-icon-input"
                               class="icon-text-input"
                               placeholder="Type or paste emoji"
                               maxlength="4">
                        <button type="button" class="btn btn-secondary btn-sm" id="clear-icon">Clear</button>
                    </div>
                    <div class="icon-suggestions" id="icon-suggestions">
                        {% for icon in crate_icons[:16] %}
                        <button type="button" class="icon-suggestion" data-icon="{{ icon }}">{{ icon }}</button>
                        {% endfor %}
                    </div>
                </div>
                <input type="hidden" id="crate-icon" name="icon" value="">
            </div>

            <!-- Color Picker -->
            <div class="form-group">
                <label>Color</label>
                <div class="color-picker" id="color-picker">
                    <button type="button" class="color-option selected" data-color="" style="background: var(--border)" title="None"></button>
                    {% for color in crate_colors %}
                    <button type="button" class="color-option" data-color="{{ color.id }}" style="background-color: {{ color.hex }}" title="{{ color.name }}"></button>
                    {% endfor %}
                    <div class="color-custom" title="Custom color">
                        <label class="color-custom-label" for="custom-color">
                            <span class="color-custom-icon">üé®</span>
                            <input type="color" id="custom-color" value="#337EA9">
                        </label>
                    </div>
                </div>
                <input type="hidden" id="crate-color" name="color" value="">
            </div>

            <input type="hidden" id="crate-parent-id" name="parent_id" value="">
            <div class="form-group" id="parent-display" style="display: none;">
                <label>Inside</label>
                <span id="parent-name" class="parent-badge"></span>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Crate</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Crates page layout - sidebar pushes content */
.crates-page-layout {
    display: flex;
    position: relative;
}

.crates-main {
    flex: 1;
    min-width: 0;
    transition: padding-right 0.3s ease;
}

body.crate-panel-open .crates-main {
    padding-right: 420px;
}

/* Crate grid - square cards like releases */
.crates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-md);
}

/* Stylised crate box */
.crate-box {
    position: relative;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    background: linear-gradient(135deg, #2a2520 0%, #1a1815 100%);
    border: 2px solid #3d352d;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
    --crate-accent: var(--primary);
}

.crate-box:hover {
    transform: translateY(-4px);
    border-color: var(--crate-accent);
}

/* Sub-crate indicator */
.crate-box.sub-crate::before {
    content: '‚Ü≥';
    position: absolute;
    top: 4px;
    left: 4px;
    font-size: 0.7rem;
    color: var(--text-muted);
    z-index: 5;
}

/* Crate lid - opens on hover */
.crate-lid {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 28px;
    background: linear-gradient(180deg, #3d352d 0%, #2a2520 100%);
    border-bottom: 2px solid #1a1815;
    transform-origin: top center;
    transition: transform 0.3s ease;
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
}

.crate-lid-inner {
    background: #1a1815;
    padding: 2px 8px;
    border-radius: 2px;
}

.crate-lid-label {
    font-size: 0.55rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--crate-accent);
    font-weight: 600;
}

.crate-box:hover .crate-lid {
    transform: rotateX(-75deg) translateY(-8px);
}

/* Crate body */
.crate-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-md);
    padding-top: 32px;
    position: relative;
    z-index: 1;
}

.crate-icon-container {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.3);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
}

.crate-emoji {
    font-size: 1.5rem;
}

.crate-info {
    text-align: center;
}

.crate-name {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
    margin-bottom: 2px;
}

.crate-stats {
    font-size: 0.65rem;
    color: var(--text-muted);
}

/* Crate slats (decorative wooden slats) */
.crate-slat {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg,
        transparent 0%,
        #3d352d 10%,
        #3d352d 90%,
        transparent 100%);
    z-index: 0;
}

.crate-slat-1 {
    bottom: 30%;
}

.crate-slat-2 {
    bottom: 60%;
}

/* Hover actions */
.crate-hover-actions {
    position: absolute;
    bottom: 8px;
    right: 8px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 10;
}

.crate-box:hover .crate-hover-actions {
    opacity: 1;
}

.crate-action-btn {
    width: 24px;
    height: 24px;
    padding: 0;
    border: 1px solid var(--border);
    background: var(--bg-surface);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.crate-action-btn:hover {
    background: var(--crate-accent);
    border-color: var(--crate-accent);
    color: var(--bg-primary);
}

/* Crate edit sidebar */
.crate-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 400px;
    height: 100vh;
    background: var(--bg-surface);
    border-left: 2px solid var(--border);
    z-index: 900;
    transform: translateX(100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
}

.crate-panel.open {
    transform: translateX(0);
}

.crate-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg-surface);
}

.crate-panel-header h3 {
    margin: 0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.crate-panel-content {
    padding: var(--space-md);
}

/* Icon/color picker styles */
.icon-picker-container {
    margin-top: var(--space-xs);
}

.icon-input-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

.icon-preview {
    width: 36px;
    height: 36px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-elevated);
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-text-input {
    flex: 1;
    max-width: 100px;
    padding: var(--space-xs);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 1rem;
    text-align: center;
    background: var(--bg-input);
    color: var(--text-primary);
}

.icon-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
}

.icon-suggestion {
    width: 26px;
    height: 26px;
    border: 1px solid transparent;
    border-radius: var(--radius-xs);
    background: var(--bg-elevated);
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-suggestion:hover {
    border-color: var(--border);
}

.color-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: var(--space-xs);
}

.color-option {
    width: 22px;
    height: 22px;
    border: 2px solid transparent;
    border-radius: 50%;
    cursor: pointer;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.selected {
    border-color: var(--text-primary);
}

.color-custom-label {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    cursor: pointer;
    border: 2px solid var(--border);
    border-radius: 50%;
}

.color-custom-icon {
    font-size: 0.7rem;
}

.color-custom input[type="color"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

/* Panel form styling */
.panel-form-group {
    margin-bottom: var(--space-md);
}

.panel-form-group label {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: var(--space-xs);
}

.panel-form-group input[type="text"] {
    width: 100%;
    padding: var(--space-sm);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-input);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.9rem;
}

.panel-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border);
}

.panel-actions .btn {
    flex: 1;
}

.panel-danger-zone {
    margin-top: var(--space-xl);
    padding-top: var(--space-md);
    border-top: 1px solid var(--error);
}

.panel-danger-zone h4 {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--error);
    margin-bottom: var(--space-sm);
}

@media (max-width: 1200px) {
    body.crate-panel-open .crates-main {
        padding-right: 0;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const modal = document.getElementById('new-crate-modal');
    const modalTitle = document.getElementById('modal-title');
    const form = document.getElementById('new-crate-form');
    const nameInput = document.getElementById('crate-name');
    const parentIdInput = document.getElementById('crate-parent-id');
    const parentDisplay = document.getElementById('parent-display');
    const parentName = document.getElementById('parent-name');
    const iconInput = document.getElementById('crate-icon');
    const colorInput = document.getElementById('crate-color');
    const iconPreview = document.getElementById('icon-preview');
    const iconTextInput = document.getElementById('crate-icon-input');
    const clearIconBtn = document.getElementById('clear-icon');
    const cratePanel = document.getElementById('crate-panel');
    const cratePanelContent = document.getElementById('crate-panel-content');
    const cratesMain = document.getElementById('crates-main');

    // Extract first emoji from string
    function extractFirstEmoji(str) {
        const emojiRegex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu;
        const match = str.match(emojiRegex);
        return match ? match[0] : null;
    }

    // Update icon from text input
    function updateIconFromInput() {
        const value = iconTextInput.value.trim();
        if (value) {
            const emoji = extractFirstEmoji(value);
            if (emoji) {
                iconInput.value = emoji;
                iconPreview.textContent = emoji;
                iconTextInput.value = emoji;
            }
        }
    }

    iconTextInput.addEventListener('input', updateIconFromInput);
    iconTextInput.addEventListener('paste', () => setTimeout(updateIconFromInput, 0));

    clearIconBtn.addEventListener('click', () => {
        iconInput.value = '';
        iconPreview.textContent = 'üìÅ';
        iconTextInput.value = '';
    });

    document.querySelectorAll('.icon-suggestion').forEach(btn => {
        btn.addEventListener('click', () => {
            const icon = btn.dataset.icon;
            iconInput.value = icon;
            iconPreview.textContent = icon;
            iconTextInput.value = icon;
        });
    });

    document.querySelectorAll('.color-option').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            colorInput.value = btn.dataset.color;
        });
    });

    const customColorInput = document.getElementById('custom-color');
    customColorInput.addEventListener('input', () => {
        document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
        colorInput.value = customColorInput.value;
    });

    function openModal(parentId = null, parentCrateName = null) {
        if (parentId) {
            modalTitle.textContent = 'New Sub-Crate';
            parentIdInput.value = parentId;
            parentName.textContent = parentCrateName;
            parentDisplay.style.display = 'block';
        } else {
            modalTitle.textContent = 'New Crate';
            parentIdInput.value = '';
            parentDisplay.style.display = 'none';
        }
        modal.classList.add('open');
        nameInput.focus();
    }

    function closeModal() {
        modal.classList.remove('open');
        form.reset();
        iconInput.value = '';
        iconPreview.textContent = 'üìÅ';
        iconTextInput.value = '';
        document.querySelectorAll('.color-option').forEach((b, i) => b.classList.toggle('selected', i === 0));
        colorInput.value = '';
    }

    document.getElementById('btn-new-crate')?.addEventListener('click', () => openModal());
    document.getElementById('btn-new-crate-empty')?.addEventListener('click', () => openModal());

    // Stop propagation on action buttons so clicking them doesn't navigate to crate
    document.querySelectorAll('.crate-subcrate-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openModal(btn.dataset.crateId, btn.dataset.crateName);
        });
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('btn-cancel').addEventListener('click', closeModal);
    document.querySelector('.modal-backdrop').addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (modal.classList.contains('open')) closeModal();
            if (cratePanel.classList.contains('open')) closePanel();
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            name: nameInput.value.trim(),
            description: document.getElementById('crate-description').value.trim(),
            parent_id: parentIdInput.value ? parseInt(parentIdInput.value) : null,
            icon: iconInput.value || null,
            color: colorInput.value || null,
        };

        try {
            const response = await fetch('/crates/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok) {
                window.location.href = '/crates/' + result.crate.id;
            } else {
                alert(result.error || 'Failed to create crate');
            }
        } catch (err) {
            alert('Error creating crate: ' + err.message);
        }
    });

    // Crate edit panel
    function openPanel(crateId) {
        cratePanel.classList.add('open');
        document.body.classList.add('crate-panel-open');
        loadCrateForEdit(crateId);
    }

    function closePanel() {
        cratePanel.classList.remove('open');
        document.body.classList.remove('crate-panel-open');
    }

    document.getElementById('crate-panel-close').addEventListener('click', closePanel);

    async function loadCrateForEdit(crateId) {
        try {
            const response = await fetch(`/crates/api/${crateId}`);
            const data = await response.json();

            if (response.ok) {
                renderPanelForm(data.crate);
            } else {
                cratePanelContent.innerHTML = '<p class="text-muted">Failed to load crate</p>';
            }
        } catch (err) {
            cratePanelContent.innerHTML = '<p class="text-muted">Error loading crate</p>';
        }
    }

    function renderPanelForm(crate) {
        cratePanelContent.innerHTML = `
            <form id="panel-edit-form">
                <div class="panel-form-group">
                    <label>Name</label>
                    <input type="text" id="panel-name" value="${crate.name || ''}" required>
                </div>
                <div class="panel-form-group">
                    <label>Description</label>
                    <input type="text" id="panel-description" value="${crate.description || ''}" placeholder="Optional description">
                </div>
                <div class="panel-form-group">
                    <label>Icon</label>
                    <div class="icon-input-row">
                        <button type="button" class="icon-preview" id="panel-icon-preview">${crate.icon || 'üìÅ'}</button>
                        <input type="text" id="panel-icon-input" class="icon-text-input" value="${crate.icon || ''}" placeholder="Emoji" maxlength="4">
                    </div>
                </div>
                <div class="panel-form-group">
                    <label>Color</label>
                    <div class="color-picker" id="panel-color-picker">
                        <button type="button" class="color-option ${!crate.color_hex ? 'selected' : ''}" data-color="" style="background: var(--border)"></button>
                        {% for color in crate_colors %}
                        <button type="button" class="color-option" data-color="{{ color.id }}" style="background-color: {{ color.hex }}"></button>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="panel-color" value="${crate.color || ''}">
                </div>
                <div class="panel-actions">
                    <button type="button" class="btn btn-secondary" id="panel-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
            <div class="panel-danger-zone">
                <h4>Danger Zone</h4>
                <button class="btn btn-secondary" id="panel-delete" style="color: var(--error)">Delete Crate</button>
            </div>
        `;

        // Setup panel form handlers
        const panelForm = document.getElementById('panel-edit-form');
        const panelIconPreview = document.getElementById('panel-icon-preview');
        const panelIconInput = document.getElementById('panel-icon-input');
        const panelColorInput = document.getElementById('panel-color');

        panelIconInput.addEventListener('input', () => {
            const emoji = extractFirstEmoji(panelIconInput.value);
            if (emoji) {
                panelIconPreview.textContent = emoji;
                panelIconInput.value = emoji;
            }
        });

        document.querySelectorAll('#panel-color-picker .color-option').forEach(btn => {
            if (btn.dataset.color === (crate.color || '')) {
                btn.classList.add('selected');
            }
            btn.addEventListener('click', () => {
                document.querySelectorAll('#panel-color-picker .color-option').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                panelColorInput.value = btn.dataset.color;
            });
        });

        document.getElementById('panel-cancel').addEventListener('click', closePanel);

        panelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const updateData = {
                name: document.getElementById('panel-name').value.trim(),
                description: document.getElementById('panel-description').value.trim(),
                icon: panelIconInput.value || null,
                color: panelColorInput.value || null,
            };

            try {
                const response = await fetch(`/crates/${crate.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const result = await response.json();
                    alert(result.error || 'Failed to update crate');
                }
            } catch (err) {
                alert('Error updating crate');
            }
        });

        document.getElementById('panel-delete').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete this crate? This cannot be undone.')) return;

            try {
                const response = await fetch(`/crates/${crate.id}`, { method: 'DELETE' });
                if (response.ok) {
                    window.location.reload();
                } else {
                    const result = await response.json();
                    alert(result.error || 'Failed to delete crate');
                }
            } catch (err) {
                alert('Error deleting crate');
            }
        });
    }

    // Edit button click handlers - stop navigation
    document.querySelectorAll('.crate-edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openPanel(btn.dataset.crateId);
        });
    });
})();
</script>
{% endblock %}
