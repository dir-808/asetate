{% extends "base.html" %}

{% block title %}Export - Asetate{% endblock %}

{% block content %}
<div class="export-page">
    <header class="page-header">
        <h1>Export</h1>
        <p class="text-secondary">Export your library to CSV for label printing</p>
    </header>

    {% if is_seller_mode %}
    <!-- Export Mode Tabs -->
    <div class="export-tabs">
        <button class="tab-btn active" data-tab="dj">DJ Export</button>
        <button class="tab-btn" data-tab="seller">Seller Export</button>
    </div>
    {% endif %}

    <div class="export-layout">
        <aside class="export-sidebar">
            <!-- Export Cue -->
            <div class="export-section card export-cue-section" id="export-cue-section" style="display: none;">
                <div class="cue-header">
                    <h3>Export Cue</h3>
                    <span class="cue-count badge" id="cue-count">0</span>
                </div>
                <p class="text-muted cue-hint">Selected items for export</p>
                <div class="cue-list" id="cue-list">
                    <!-- Cue items will be loaded here -->
                </div>
                <div class="cue-actions">
                    <button class="btn btn-secondary btn-sm" id="btn-clear-cue">Clear Cue</button>
                    <button class="btn btn-primary btn-sm" id="btn-export-cue">Export Cue</button>
                </div>
            </div>

            <!-- Presets -->
            <div class="export-section card">
                <h3>Presets</h3>
                {% if presets %}
                <div class="preset-list">
                    {% for preset in presets %}
                    <button class="preset-btn" data-preset-id="{{ preset.id }}">
                        {{ preset.name }}
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No saved presets</p>
                {% endif %}
            </div>

            <!-- Filters -->
            <div class="export-section card">
                <h3>Filters</h3>

                <div class="filter-group">
                    <label for="filter-crate">Crate</label>
                    <select id="filter-crate" name="crate_id">
                        <option value="">All crates</option>
                        {% for crate in crates %}
                        <option value="{{ crate.id }}">{{ crate.full_path }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-search">Search</label>
                    <input type="text" id="filter-search" name="search" placeholder="Artist, title...">
                </div>

                <div class="filter-group dj-filter">
                    <label>BPM Range</label>
                    <div class="range-inputs">
                        <input type="number" id="filter-bpm-min" placeholder="Min" min="20" max="300">
                        <span>to</span>
                        <input type="number" id="filter-bpm-max" placeholder="Max" min="20" max="300">
                    </div>
                </div>

                <div class="filter-group dj-filter">
                    <label>Energy</label>
                    <div class="range-inputs">
                        <input type="number" id="filter-energy-min" min="1" max="10" placeholder="Min">
                        <span>to</span>
                        <input type="number" id="filter-energy-max" min="1" max="10" placeholder="Max">
                    </div>
                </div>

                <div class="filter-group dj-filter">
                    <label for="filter-key">Key / Camelot</label>
                    <input type="text" id="filter-key" name="key" placeholder="e.g., 8A, Am">
                </div>

                <div class="filter-group">
                    <label for="filter-tags">Tags</label>
                    <input type="text" id="filter-tags" placeholder="house, deep, vocal...">
                </div>

                <div class="filter-group dj-filter">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-playable" checked>
                        <span>Playable tracks only</span>
                    </label>
                </div>

                <div class="filter-group dj-filter">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-has-bpm">
                        <span>Has BPM</span>
                    </label>
                </div>

                <div class="filter-group dj-filter">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-has-key">
                        <span>Has Key</span>
                    </label>
                </div>

                <div class="filter-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-not-exported">
                        <span>Only items not yet exported</span>
                    </label>
                </div>

                <button class="btn btn-secondary btn-block" id="btn-clear-filters">Clear Filters</button>
            </div>

            <!-- Export Grouping -->
            <div class="export-section card">
                <h3>Export Format</h3>
                <div class="filter-group">
                    <label>Group by release</label>
                    <div class="toggle-switch-wrapper">
                        <span class="toggle-label-left">Tracks</span>
                        <label class="toggle">
                            <input type="checkbox" id="export-group-by-release" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label-right">Releases</span>
                    </div>
                    <p class="text-muted toggle-hint" id="grouping-hint">One row per release with playable track info combined</p>
                </div>
            </div>

            <!-- Columns -->
            <div class="export-section card">
                <h3>Columns</h3>
                <div class="column-checkboxes" id="column-checkboxes">
                    {% for col_id, col_label in columns %}
                    <label class="checkbox-label" data-column="{{ col_id }}">
                        <input type="checkbox" name="columns" value="{{ col_id }}"
                            {% if col_id in default_columns %}checked{% endif %}>
                        <span>{{ col_label }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </aside>

        <main class="export-main">
            <div class="preview-header">
                <div>
                    <h2>Preview</h2>
                    <span class="preview-count" id="preview-count">Loading...</span>
                </div>
                <div class="export-actions">
                    <label class="checkbox-label select-all-label">
                        <input type="checkbox" id="select-all-checkbox">
                        <span>Select All</span>
                    </label>
                    <button class="btn btn-secondary" id="btn-add-selected">Add to Cue</button>
                    <button class="btn btn-secondary" id="btn-save-preset">Save Preset</button>
                    <button class="btn btn-primary" id="btn-download">Download CSV</button>
                </div>
            </div>

            <div class="preview-table-wrapper" id="preview-wrapper">
                <p class="text-muted loading-message">Loading preview...</p>
            </div>
        </main>
    </div>
</div>

<!-- Save Preset Modal -->
<div class="modal" id="preset-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-content-sm">
        <div class="modal-header">
            <h2>Save Preset</h2>
            <button class="modal-close" id="preset-modal-close">&times;</button>
        </div>
        <form id="preset-form">
            <div class="form-group">
                <label for="preset-name">Preset Name</label>
                <input type="text" id="preset-name" placeholder="e.g., House 120-130 BPM" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="preset-btn-cancel">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Export tabs */
.export-tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    border-bottom: 2px solid var(--bg-surface);
    padding-bottom: var(--space-xs);
}
.tab-btn {
    background: transparent;
    border: none;
    padding: var(--space-sm) var(--space-md);
    font-size: 1rem;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}
.tab-btn:hover {
    color: var(--text-primary);
}
.tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

/* Export cue */
.export-cue-section {
    border-left: 3px solid var(--primary);
}
.cue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.cue-header h3 {
    margin: 0;
}
.cue-count {
    background: var(--primary);
    color: var(--bg-body);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
}
.cue-hint {
    font-size: 0.85rem;
    margin: var(--space-xs) 0;
}
.cue-list {
    max-height: 200px;
    overflow-y: auto;
    margin: var(--space-sm) 0;
}
.cue-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) 0;
    border-bottom: 1px solid var(--bg-surface);
    font-size: 0.85rem;
}
.cue-item:last-child {
    border-bottom: none;
}
.cue-item-info {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}
.cue-item-remove {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 2px 6px;
    font-size: 1rem;
}
.cue-item-remove:hover {
    color: var(--text-primary);
}
.cue-actions {
    display: flex;
    gap: var(--space-xs);
    margin-top: var(--space-sm);
}

/* Selection controls */
.select-all-label {
    margin-right: var(--space-md);
}
.preview-table .row-checkbox {
    width: 20px;
    cursor: pointer;
}
.row-checkbox-col {
    width: 30px;
    text-align: center;
}

/* Seller mode column highlighting */
.seller-column {
    background: rgba(249, 115, 22, 0.1);
}

/* Toggle switch for export format */
.toggle-switch-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-xs);
}

.toggle-label-left,
.toggle-label-right {
    font-size: 0.8rem;
    color: var(--primary);
    font-weight: 500;
}

.toggle-hint {
    font-size: 0.75rem;
    margin-top: var(--space-xs);
}
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let debounceTimer = null;
    let currentMode = 'dj'; // 'dj' or 'seller'
    let exportCue = JSON.parse(localStorage.getItem('asetate_export_cue') || '[]');

    // Column categories
    const djColumns = ['artist', 'release_title', 'track_title', 'position', 'label', 'year', 'bpm', 'musical_key', 'camelot', 'energy', 'duration', 'notes', 'tags', 'crates', 'release_url'];
    const sellerColumns = ['artist', 'release_title', 'condition', 'sleeve_condition', 'price', 'location', 'listing_url', 'discogs_id'];
    const djDefaultColumns = ['artist', 'release_title', 'track_title', 'position', 'bpm', 'musical_key'];
    const sellerDefaultColumns = ['artist', 'release_title', 'condition', 'price', 'location', 'listing_url'];

    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.tab;
            applyModeSettings();
            updatePreview();
        });
    });

    function applyModeSettings() {
        // Show/hide DJ-specific filters
        document.querySelectorAll('.dj-filter').forEach(el => {
            el.style.display = currentMode === 'dj' ? 'block' : 'none';
        });

        // Update column checkboxes based on mode
        const columnContainer = document.getElementById('column-checkboxes');
        const checkboxes = columnContainer.querySelectorAll('input[name="columns"]');
        const targetColumns = currentMode === 'dj' ? djColumns : sellerColumns;
        const defaultCols = currentMode === 'dj' ? djDefaultColumns : sellerDefaultColumns;

        checkboxes.forEach(cb => {
            const label = cb.closest('label');
            const colId = cb.value;

            // Show only relevant columns for the mode
            if (currentMode === 'seller') {
                // In seller mode, show seller columns prominently
                if (sellerColumns.includes(colId)) {
                    label.style.display = 'flex';
                    label.classList.add('seller-column');
                } else {
                    label.style.display = 'none';
                }
            } else {
                // In DJ mode, show DJ columns
                if (djColumns.includes(colId)) {
                    label.style.display = 'flex';
                    label.classList.remove('seller-column');
                } else {
                    label.style.display = 'none';
                }
            }

            // Set defaults for mode
            cb.checked = defaultCols.includes(colId);
        });
    }

    // Collect current filter values
    function getFilters() {
        const filters = {
            crate_id: document.getElementById('filter-crate').value,
            search: document.getElementById('filter-search').value,
            tags: document.getElementById('filter-tags').value,
            not_exported: document.getElementById('filter-not-exported').checked,
            group_by_release: document.getElementById('export-group-by-release')?.checked || false,
        };

        // DJ-specific filters
        if (currentMode === 'dj') {
            filters.bpm_min = document.getElementById('filter-bpm-min').value;
            filters.bpm_max = document.getElementById('filter-bpm-max').value;
            filters.energy_min = document.getElementById('filter-energy-min').value;
            filters.energy_max = document.getElementById('filter-energy-max').value;
            filters.key = document.getElementById('filter-key').value;
            filters.playable_only = document.getElementById('filter-playable').checked;
            filters.has_bpm = document.getElementById('filter-has-bpm').checked;
            filters.has_key = document.getElementById('filter-has-key').checked;
        }

        return filters;
    }

    // Collect selected columns
    function getColumns() {
        return Array.from(document.querySelectorAll('input[name="columns"]:checked'))
            .map(cb => cb.value);
    }

    // Set filters from object (for presets)
    function setFilters(filters) {
        document.getElementById('filter-crate').value = filters.crate_id || '';
        document.getElementById('filter-search').value = filters.search || '';
        document.getElementById('filter-bpm-min').value = filters.bpm_min || '';
        document.getElementById('filter-bpm-max').value = filters.bpm_max || '';
        document.getElementById('filter-energy-min').value = filters.energy_min || '';
        document.getElementById('filter-energy-max').value = filters.energy_max || '';
        document.getElementById('filter-key').value = filters.key || '';
        document.getElementById('filter-tags').value = filters.tags || '';
        document.getElementById('filter-playable').checked = filters.playable_only !== false;
        document.getElementById('filter-has-bpm').checked = !!filters.has_bpm;
        document.getElementById('filter-has-key').checked = !!filters.has_key;
        document.getElementById('filter-not-exported').checked = !!filters.not_exported;
    }

    // Set columns from array
    function setColumns(columns) {
        document.querySelectorAll('input[name="columns"]').forEach(cb => {
            cb.checked = columns.includes(cb.value);
        });
    }

    // Export Cue Management
    function updateCueUI() {
        const section = document.getElementById('export-cue-section');
        const countEl = document.getElementById('cue-count');
        const listEl = document.getElementById('cue-list');

        countEl.textContent = exportCue.length;

        if (exportCue.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        listEl.innerHTML = exportCue.map((item, idx) => `
            <div class="cue-item">
                <span class="cue-item-info" title="${item.artist} - ${item.title}">
                    ${item.artist} - ${item.title}
                </span>
                <button class="cue-item-remove" data-idx="${idx}">&times;</button>
            </div>
        `).join('');

        // Add remove handlers
        listEl.querySelectorAll('.cue-item-remove').forEach(btn => {
            btn.addEventListener('click', () => {
                const idx = parseInt(btn.dataset.idx);
                exportCue.splice(idx, 1);
                saveCue();
                updateCueUI();
            });
        });
    }

    function saveCue() {
        localStorage.setItem('asetate_export_cue', JSON.stringify(exportCue));
    }

    function addToCue(items) {
        items.forEach(item => {
            // Avoid duplicates by track_id
            if (!exportCue.some(q => q.track_id === item.track_id)) {
                exportCue.push(item);
            }
        });
        saveCue();
        updateCueUI();
    }

    document.getElementById('btn-clear-cue').addEventListener('click', () => {
        exportCue = [];
        saveCue();
        updateCueUI();
    });

    // Update preview
    async function updatePreview() {
        const wrapper = document.getElementById('preview-wrapper');
        const countEl = document.getElementById('preview-count');

        wrapper.innerHTML = '<p class="text-muted loading-message">Loading preview...</p>';

        const filters = getFilters();
        const columns = getColumns();

        if (columns.length === 0) {
            wrapper.innerHTML = '<p class="text-muted">Select at least one column to preview</p>';
            countEl.textContent = '0 tracks';
            return;
        }

        try {
            const response = await fetch('/export/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filters, columns, limit: 50, mode: currentMode }),
            });

            const data = await response.json();
            countEl.textContent = `${data.count} track${data.count !== 1 ? 's' : ''}`;

            if (data.tracks.length === 0) {
                wrapper.innerHTML = '<p class="text-muted">No tracks match your filters</p>';
                return;
            }

            // Build table with checkboxes
            const columnLabels = {
                artist: 'Artist',
                release_title: 'Release',
                track_title: 'Track',
                position: 'Side',
                label: 'Label',
                year: 'Year',
                bpm: 'BPM',
                musical_key: 'Key',
                camelot: 'Camelot',
                energy: 'Energy',
                duration: 'Length',
                notes: 'Notes',
                tags: 'Tags',
                crates: 'Crates',
                release_url: 'URL',
                discogs_id: 'Discogs ID',
                condition: 'Condition',
                sleeve_condition: 'Sleeve',
                price: 'Price',
                location: 'Location',
                listing_url: 'Listing URL',
            };

            let html = '<table class="preview-table"><thead><tr>';
            html += '<th class="row-checkbox-col"><input type="checkbox" id="header-select-all"></th>';
            for (const col of columns) {
                html += `<th>${columnLabels[col] || col}</th>`;
            }
            html += '</tr></thead><tbody>';

            for (const track of data.tracks) {
                const trackData = JSON.stringify({
                    track_id: track.track_id,
                    release_id: track.release_id,
                    artist: track.artist || '',
                    title: track.track_title || track.release_title || '',
                }).replace(/"/g, '&quot;');

                html += `<tr data-track='${trackData}'>`;
                html += `<td class="row-checkbox-col"><input type="checkbox" class="row-checkbox"></td>`;
                for (const col of columns) {
                    html += `<td>${track[col] || 'â€”'}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody></table>';

            if (data.count > data.preview_count) {
                html += `<p class="text-muted preview-note">Showing ${data.preview_count} of ${data.count} tracks</p>`;
            }

            wrapper.innerHTML = html;

            // Header select-all checkbox
            const headerCheckbox = document.getElementById('header-select-all');
            headerCheckbox.addEventListener('change', () => {
                document.querySelectorAll('.row-checkbox').forEach(cb => {
                    cb.checked = headerCheckbox.checked;
                });
                updateSelectAllState();
            });

            // Individual row checkboxes
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelectAllState);
            });

        } catch (err) {
            console.error('Preview failed:', err);
            wrapper.innerHTML = '<p class="text-error">Failed to load preview</p>';
        }
    }

    function updateSelectAllState() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const checked = document.querySelectorAll('.row-checkbox:checked');
        const selectAllCb = document.getElementById('select-all-checkbox');
        const headerCb = document.getElementById('header-select-all');

        if (selectAllCb) {
            selectAllCb.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
            selectAllCb.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
        }
        if (headerCb) {
            headerCb.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
            headerCb.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
        }
    }

    // Select all (in header)
    document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
        document.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
        });
    });

    // Add selected to cue
    document.getElementById('btn-add-selected').addEventListener('click', () => {
        const selected = [];
        document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
            const row = cb.closest('tr');
            const data = JSON.parse(row.dataset.track);
            selected.push(data);
        });

        if (selected.length === 0) {
            alert('Select at least one item to add to cue');
            return;
        }

        addToCue(selected);

        // Uncheck all
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
        updateSelectAllState();
    });

    // Debounced preview update
    function debouncedUpdate() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updatePreview, 300);
    }

    // Attach filter change listeners
    document.querySelectorAll('.export-sidebar input, .export-sidebar select').forEach(el => {
        el.addEventListener('input', debouncedUpdate);
        el.addEventListener('change', debouncedUpdate);
    });

    // Clear filters
    document.getElementById('btn-clear-filters').addEventListener('click', () => {
        document.getElementById('filter-crate').value = '';
        document.getElementById('filter-search').value = '';
        document.getElementById('filter-bpm-min').value = '';
        document.getElementById('filter-bpm-max').value = '';
        document.getElementById('filter-energy-min').value = '';
        document.getElementById('filter-energy-max').value = '';
        document.getElementById('filter-key').value = '';
        document.getElementById('filter-tags').value = '';
        document.getElementById('filter-playable').checked = true;
        document.getElementById('filter-has-bpm').checked = false;
        document.getElementById('filter-has-key').checked = false;
        document.getElementById('filter-not-exported').checked = false;
        updatePreview();
    });

    // Download CSV
    document.getElementById('btn-download').addEventListener('click', async () => {
        const filters = getFilters();
        const columns = getColumns();

        if (columns.length === 0) {
            alert('Select at least one column to export');
            return;
        }

        try {
            const response = await fetch('/export/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filters, columns, mark_exported: true }),
            });

            if (!response.ok) {
                throw new Error('Download failed');
            }

            // Get filename from header
            const disposition = response.headers.get('Content-Disposition');
            const filenameMatch = disposition && disposition.match(/filename=(.+)/);
            const filename = filenameMatch ? filenameMatch[1] : 'asetate_export.csv';

            // Download file
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } catch (err) {
            console.error('Download failed:', err);
            alert('Failed to download CSV');
        }
    });

    // Export cue
    document.getElementById('btn-export-cue').addEventListener('click', async () => {
        if (exportCue.length === 0) {
            alert('Cue is empty');
            return;
        }

        const columns = getColumns();
        if (columns.length === 0) {
            alert('Select at least one column to export');
            return;
        }

        const trackIds = exportCue.map(q => q.track_id);

        try {
            const response = await fetch('/export/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ track_ids: trackIds, columns, mark_exported: true }),
            });

            if (!response.ok) {
                throw new Error('Download failed');
            }

            const disposition = response.headers.get('Content-Disposition');
            const filenameMatch = disposition && disposition.match(/filename=(.+)/);
            const filename = filenameMatch ? filenameMatch[1] : 'asetate_export.csv';

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            // Clear cue after successful export
            exportCue = [];
            saveCue();
            updateCueUI();
        } catch (err) {
            console.error('Download failed:', err);
            alert('Failed to download CSV');
        }
    });

    // Preset modal
    const presetModal = document.getElementById('preset-modal');
    const presetForm = document.getElementById('preset-form');

    document.getElementById('btn-save-preset').addEventListener('click', () => {
        presetModal.classList.add('open');
        document.getElementById('preset-name').focus();
    });

    document.getElementById('preset-modal-close').addEventListener('click', () => {
        presetModal.classList.remove('open');
    });

    document.getElementById('preset-btn-cancel').addEventListener('click', () => {
        presetModal.classList.remove('open');
    });

    presetModal.querySelector('.modal-backdrop').addEventListener('click', () => {
        presetModal.classList.remove('open');
    });

    presetForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('preset-name').value.trim();
        if (!name) return;

        const filters = getFilters();
        const columns = getColumns();

        try {
            const response = await fetch('/export/presets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, filters, columns }),
            });

            if (response.ok) {
                presetModal.classList.remove('open');
                presetForm.reset();
                window.location.reload();
            } else {
                const result = await response.json();
                alert(result.error || 'Failed to save preset');
            }
        } catch (err) {
            alert('Error saving preset');
        }
    });

    // Load preset
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const presetId = btn.dataset.presetId;
            try {
                const response = await fetch(`/export/presets/${presetId}`);
                const preset = await response.json();

                setFilters(preset.filters || {});
                setColumns(preset.columns || []);
                updatePreview();
            } catch (err) {
                console.error('Failed to load preset:', err);
            }
        });
    });

    // Escape key closes modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && presetModal.classList.contains('open')) {
            presetModal.classList.remove('open');
        }
    });

    // Export grouping toggle
    const groupingToggle = document.getElementById('export-group-by-release');
    const groupingHint = document.getElementById('grouping-hint');
    const leftLabel = document.querySelector('.toggle-label-left');
    const rightLabel = document.querySelector('.toggle-label-right');

    function updateGroupingUI() {
        const isRelease = groupingToggle.checked;
        groupingHint.textContent = isRelease
            ? 'One row per release with playable track info combined'
            : 'One row per playable track';
    }

    groupingToggle.addEventListener('change', () => {
        updateGroupingUI();
        updatePreview();
    });

    // Initialize grouping UI
    updateGroupingUI();

    // Initialize
    updateCueUI();
    {% if is_seller_mode %}
    applyModeSettings();
    {% endif %}
    updatePreview();
})();
</script>
{% endblock %}
